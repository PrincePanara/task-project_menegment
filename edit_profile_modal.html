<style>
    /* Modal styles */
    .modal {
        display: none; /* Hidden by default */
        position: fixed; /* Stay in place */
        z-index: 1000; /* Sit on top */
        left: 0;
        top: 0;
        width: 100%; /* Full width */
        height: 100%; /* Full height */
        overflow: auto; /* Enable scroll if needed */
        background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
        display: flex; /* Use flexbox to center content */
        justify-content: center;
        align-items: center;
        animation: fadeIn 0.3s ease-out forwards;
    }

    .modal-content {
        background-color: #fefefe;
        margin: auto;
        padding: 2.5rem;
        border-radius: 16px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        width: 90%;
        max-width: 500px;
        animation: scaleIn 0.3s ease-out forwards;
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid #E5E7EB;
    }

    .modal-header h2 {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--text-main);
    }

    .close-button {
        color: #aaa;
        font-size: 2rem;
        font-weight: bold;
        cursor: pointer;
        transition: color 0.2s;
    }
    .close-button:hover,
    .close-button:focus {
        color: var(--primary-black);
        text-decoration: none;
        cursor: pointer;
    }

    .form-group {
        margin-bottom: 1.5rem;
    }

    .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 600;
        color: var(--text-main);
        font-size: 0.9rem;
    }

    .form-group input[type="text"],
    .form-group textarea {
        width: 100%;
        padding: 0.8rem 1rem;
        border: 1px solid #E5E7EB;
        border-radius: 8px;
        font-size: 1rem;
        color: var(--text-main);
        outline: none;
        transition: border-color 0.2s;
    }

    .form-group input[type="text"]:focus,
    .form-group textarea:focus {
        border-color: var(--primary-black);
    }

    .form-group textarea {
        min-height: 100px;
        resize: vertical;
    }

    .skills-input-wrapper {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        border: 1px solid #E5E7EB;
        border-radius: 8px;
        padding: 8px;
        margin-bottom: 0.5rem;
        min-height: 44px;
    }

    .skill-tag {
        background-color: #F3F4F6;
        color: var(--text-main);
        padding: 5px 10px;
        border-radius: 20px;
        font-size: 0.85rem;
        display: flex;
        align-items: center;
        gap: 5px;
    }

    .skill-tag .remove-skill {
        cursor: pointer;
        font-weight: bold;
        color: #9CA3AF;
        transition: color 0.2s;
    }
    .skill-tag .remove-skill:hover {
        color: var(--primary-black);
    }

    .skills-add-input {
        flex-grow: 1;
        border: none;
        outline: none;
        padding: 5px 0;
        font-size: 1rem;
        min-width: 80px;
    }


    .modal-actions {
        display: flex;
        justify-content: flex-end; /* Buttons right align */
        gap: 1rem;
        margin-top: 2rem;
        padding-top: 1.5rem;
        border-top: 1px solid #E5E7EB;
    }

    .modal-actions .btn-cancel {
        background: transparent;
        border: none;
        color: var(--text-gray);
        padding: 10px 20px;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: 0.2s;
    }
    .modal-actions .btn-cancel:hover {
        color: var(--primary-black);
    }

    .modal-actions .btn-save {
        background: var(--primary-black);
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: 0.2s;
    }
    .modal-actions .btn-save:hover {
        background: #333;
    }

    /* Avatar Upload */
    .avatar-upload-section {
        display: flex;
        align-items: center;
        gap: 20px;
        margin-bottom: 2rem;
        padding-bottom: 1.5rem;
        border-bottom: 1px solid #F3F4F6;
    }
    .avatar-preview {
        width: 90px;
        height: 90px;
        border-radius: 50%;
        object-fit: cover;
        border: 2px solid #E5E7EB;
        background: #f0f0f0;
    }
    .avatar-upload-buttons {
        display: flex;
        gap: 10px;
    }
    .btn-upload-avatar {
        background: #F3F4F6;
        border: 1px solid #E5E7EB;
        color: var(--text-main);
        padding: 8px 15px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 500;
        font-size: 0.9rem;
        transition: 0.2s;
    }
    .btn-upload-avatar:hover {
        background: #E5E7EB;
    }
    .file-input {
        display: none; /* Hide default file input */
    }

</style>

<div id="editProfileModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Edit Profile</h2>
            <span class="close-button" onclick="closeEditProfileModal()">&times;</span>
        </div>

        <div class="avatar-upload-section">
            <img id="modalAvatarPreview" src="https://ui-avatars.com/api/?name=User&size=128" alt="Avatar Preview" class="avatar-preview">
            <div class="avatar-upload-buttons">
                <input type="file" id="avatarFileInput" class="file-input" accept="image/*">
                <button class="btn-upload-avatar" onclick="document.getElementById('avatarFileInput').click()"><i class="ri-upload-cloud-2-line"></i> Change Photo</button>
                <button class="btn-upload-avatar" style="color: #EF4444; border-color: #EF4444;" onclick="removeAvatar()"><i class="ri-delete-bin-line"></i> Remove</button>
            </div>
        </div>

        <div class="form-group">
            <label for="editFullName">Full Name</label>
            <input type="text" id="editFullName" placeholder="Rahul V.">
        </div>

        <div class="form-group">
            <label for="editRole">Role</label>
            <input type="text" id="editRole" placeholder="Senior Product Manager">
        </div>

        <div class="form-group">
            <label for="editLocation">Location</label>
            <input type="text" id="editLocation" placeholder="Mumbai, India">
        </div>

        <div class="form-group">
            <label for="editAboutMe">About Me</label>
            <textarea id="editAboutMe" placeholder="Tell us about yourself..."></textarea>
        </div>

        <div class="form-group">
            <label for="editSkills">Skills (Press Enter to add)</label>
            <div id="skillsInputWrapper" class="skills-input-wrapper">
                <input type="text" id="editSkillsInput" class="skills-add-input" placeholder="Add a skill">
            </div>
        </div>

        <div class="modal-actions">
            <button class="btn-cancel" onclick="closeEditProfileModal()">Cancel</button>
            <button class="btn-save" onclick="saveProfileChanges()">Save Changes</button>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import { getAuth, updateProfile } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDL6UGG7s7o-MC24qpHS77LgY54jxD0sRI",
        authDomain: "taskmanagement-60f9b.firebaseapp.com",
        projectId: "taskmanagement-60f9b",
        storageBucket: "taskmanagement-60f9b.firebasestorage.app",
        messagingSenderId: "761115679422",
        appId: "1:761115679422:web:ee166eb1935bd360aa9cef",
        measurementId: "G-F55KPBTQ3G"
    };

    const CLOUDINARY_URL = "https://api.cloudinary.com/v1_1/dl6gzgu6i/image/upload";
    const CLOUDINARY_UPLOAD_PRESET = "NEWSIMAGE";

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let currentUser = null;
    let currentUserData = null;
    let uploadedImageUrl = '';

    auth.onAuthStateChanged(async (user) => {
        if (user) {
            currentUser = user;
            const userDoc = await getDoc(doc(db, "users", user.uid));
            if (userDoc.exists()) {
                currentUserData = userDoc.data();
            }
        }
    });

    // Avatar file input handler with Cloudinary upload
    document.getElementById('avatarFileInput').addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        const formData = new FormData();
        formData.append('file', file);
        formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);

        try {
            const response = await fetch(CLOUDINARY_URL, {
                method: 'POST',
                body: formData
            });
            const data = await response.json();
            uploadedImageUrl = data.secure_url;
            document.getElementById('modalAvatarPreview').src = uploadedImageUrl;
        } catch (error) {
            console.error('Image upload failed:', error);
            alert('Failed to upload image');
        }
    });

    // Remove avatar function
    window.removeAvatar = () => {
        document.getElementById('modalAvatarPreview').src = `https://ui-avatars.com/api/?name=${currentUser?.displayName || 'User'}&size=128`;
        document.getElementById('avatarFileInput').value = '';
        uploadedImageUrl = '';
    };

    // Close edit profile modal
    window.closeEditProfileModal = () => {
        document.getElementById('editProfileModal').classList.remove('active');
    };

    // Open edit profile modal and load current data
    window.openEditProfileModal = async () => {
        if (!currentUser) {
            alert('Please log in first');
            return;
        }

        document.getElementById('editProfileModal').classList.add('active');

        // Load current user data
        document.getElementById('editFullName').value = currentUser.displayName || '';
        document.getElementById('modalAvatarPreview').src = currentUser.photoURL || `https://ui-avatars.com/api/?name=${currentUser.displayName}&size=128`;

        if (currentUserData) {
            document.getElementById('editRole').value = currentUserData.role || '';
            document.getElementById('editLocation').value = currentUserData.location || '';
            document.getElementById('editAboutMe').value = currentUserData.about || '';
            renderEditSkills(currentUserData.skills || []);
        } else {
            renderEditSkills([]);
        }

        uploadedImageUrl = currentUser.photoURL || '';
    };

    // Render skills
    function renderEditSkills(skills) {
        const wrapper = document.getElementById('skillsInputWrapper');
        wrapper.innerHTML = '';

        skills.forEach(skill => {
            if (skill && skill.trim()) {
                const tag = document.createElement('div');
                tag.className = 'skill-tag';
                tag.innerHTML = `<span>${skill}</span> <span class="remove-skill" onclick="this.parentElement.remove()">×</span>`;
                wrapper.appendChild(tag);
            }
        });

        const input = document.createElement('input');
        input.type = 'text';
        input.className = 'skills-add-input';
        input.placeholder = 'Add a skill and press Enter';
        input.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && this.value.trim()) {
                e.preventDefault();
                const tag = document.createElement('div');
                tag.className = 'skill-tag';
                tag.innerHTML = `<span>${this.value.trim()}</span> <span class="remove-skill" onclick="this.parentElement.remove()">×</span>`;
                wrapper.insertBefore(tag, input);
                this.value = '';
            }
        });
        wrapper.appendChild(input);
    }

    // Save profile changes
    window.saveProfileChanges = async () => {
        if (!currentUser) {
            alert('Please log in first');
            return;
        }

        const fullName = document.getElementById('editFullName').value.trim();
        const role = document.getElementById('editRole').value.trim();
        const location = document.getElementById('editLocation').value.trim();
        const about = document.getElementById('editAboutMe').value.trim();

        if (!fullName) {
            alert('Full name is required');
            return;
        }

        // Get skills from tags
        const skillTags = document.querySelectorAll('#skillsInputWrapper .skill-tag');
        const skills = Array.from(skillTags).map(tag => {
            const spans = tag.querySelectorAll('span');
            return spans[0].textContent.trim();
        });

        try {
            // Update Firebase Auth displayName
            await updateProfile(currentUser, {
                displayName: fullName,
                photoURL: uploadedImageUrl || currentUser.photoURL
            });

            // Update Firestore user document
            await setDoc(doc(db, 'users', currentUser.uid), {
                role: role,
                location: location,
                about: about,
                skills: skills,
                profileImage: uploadedImageUrl || currentUser.photoURL,
                updatedAt: new Date()
            }, { merge: true });

            alert('Profile updated successfully!');
            closeEditProfileModal();

            // Refresh page to see changes
            setTimeout(() => {
                window.location.reload();
            }, 500);

        } catch (error) {
            console.error('Error saving profile:', error);
            alert('Error saving profile: ' + error.message);
        }
    };
</script>
