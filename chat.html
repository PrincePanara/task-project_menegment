<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat - AProjectO</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">

    <style>
        :root { --bg-color: #FFFFFF; --sidebar-width: 260px; --primary-black: #000000; --text-main: #111827; --text-gray: #6B7280; --border-color: #E5E7EB; --chat-bubble-in: #F3F4F6; --chat-bubble-out: #000000; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { display: flex; height: 100vh; background-color: var(--bg-color); color: var(--text-main); overflow: hidden; }

        /* Sidebar */
        .sidebar { width: var(--sidebar-width); background: #fff; border-right: 1px solid var(--border-color); padding: 1.5rem; display: flex; flex-direction: column; flex-shrink: 0; transition: transform 0.3s ease; z-index: 100; }
        .brand { display: flex; align-items: center; gap: 10px; margin-bottom: 2.5rem; font-weight: 800; font-size: 1.2rem; }
        .menu-title { font-size: 0.75rem; color: #9CA3AF; margin-bottom: 1rem; font-weight: 600; text-transform: uppercase; }
        .nav-item { display: flex; align-items: center; gap: 12px; padding: 0.75rem 1rem; border-radius: 8px; color: var(--text-gray); text-decoration: none; font-weight: 500; margin-bottom: 0.5rem; transition: 0.2s; }
        .nav-item:hover:not(.active) { background: #F3F4F6; }
        .nav-item.active { background-color: var(--primary-black); color: white; }
        .user-profile { margin-top: auto; display: flex; align-items: center; gap: 12px; padding-top: 1.5rem; border-top: 1px solid var(--border-color); }
        .avatar-small { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; }

        /* Chat Layout */
        .chat-layout { display: flex; flex: 1; height: 100vh; }
        .message-list-panel { width: 350px; border-right: 1px solid var(--border-color); display: flex; flex-direction: column; background: white; position: relative; }
        .msg-header { padding: 1.5rem; position: relative; }
        .msg-title-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        .msg-title-row h2 { font-size: 1.5rem; font-weight: 700; }
        .mobile-menu-btn { display: none; font-size: 1.5rem; cursor: pointer; margin-right: 10px; }

        .add-btn { background: black; color: white; width: 35px; height: 35px; border-radius: 50%; display: grid; place-items: center; cursor: pointer; transition: 0.2s; position: relative; }
        .search-box { position: relative; }
        .search-box i { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #9CA3AF; }
        .search-box input { width: 100%; padding: 10px 10px 10px 35px; border: 1px solid var(--border-color); border-radius: 8px; outline: none; background: #fff; }
        
        .contacts-container { flex: 1; overflow-y: auto; padding: 0 1rem 1rem 1rem; }
        .contact-item { display: flex; align-items: center; gap: 12px; padding: 12px; border-radius: 12px; cursor: pointer; transition: 0.2s; margin-bottom: 5px; }
        .contact-item:hover { background: #F9FAFB; }
        .contact-item.active { background: var(--primary-black); color: white; }
        .contact-item.active .last-msg { color: #aaa; }
        .contact-item.active .c-name { color: white; }
        .c-avatar { width: 45px; height: 45px; border-radius: 50%; object-fit: cover; background: #eee; flex-shrink: 0; border: 1px solid #eee;}
        .c-info { flex: 1; overflow: hidden; }
        .c-name { font-weight: 600; font-size: 0.95rem; margin-bottom: 2px; color: var(--text-main); }
        .last-msg { font-size: 0.8rem; color: var(--text-gray); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        .chat-window { flex: 1; display: flex; flex-direction: column; background: white; position: relative; }
        .chat-header { padding: 1rem 2rem; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; height: 70px; }
        .chat-user-info { display: flex; align-items: center; gap: 12px; cursor: pointer; padding: 5px 10px; border-radius: 8px; transition: 0.2s; }
        .header-icons i { font-size: 1.2rem; color: #9CA3AF; margin-left: 15px; cursor: pointer; }
        
        .messages-area { flex: 1; padding: 2rem; overflow-y: auto; display: flex; flex-direction: column; gap: 1rem; background: #fff; }
        .message { display: flex; width: 100%; }
        .message.incoming { justify-content: flex-start; }
        .message.outgoing { justify-content: flex-end; }
        .bubble { max-width: 60%; padding: 12px 18px; border-radius: 12px; font-size: 0.95rem; line-height: 1.5; position: relative; animation: fadeInUp 0.3s ease-out; }
        .incoming .bubble { background: var(--chat-bubble-in); color: var(--text-main); border-bottom-left-radius: 2px; }
        .outgoing .bubble { background: var(--chat-bubble-out); color: white; border-bottom-right-radius: 2px; }
        .msg-time { font-size: 0.7rem; margin-top: 5px; opacity: 0.7; text-align: right; display: block; }

        .input-area { padding: 1.5rem 2rem; border-top: 1px solid var(--border-color); display: flex; align-items: center; gap: 15px; }
        .input-wrapper { flex: 1; background: #F9FAFB; border-radius: 30px; padding: 10px 20px; display: flex; align-items: center; }
        .chat-input { flex: 1; background: transparent; border: none; outline: none; font-size: 0.95rem; margin: 0 10px; }
        .send-btn { width: 45px; height: 45px; background: var(--primary-black); color: white; border-radius: 12px; border: none; display: grid; place-items: center; cursor: pointer; transition: 0.2s; }
        .empty-chat { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: var(--text-gray); }

        .dropdown-menu { position: absolute; top: 60px; right: 20px; background: white; border: 1px solid #E5E7EB; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 200px; display: none; flex-direction: column; z-index: 100; overflow: hidden; }
        .dropdown-menu.show { display: flex; }
        .dropdown-item { padding: 12px 15px; display: flex; align-items: center; gap: 10px; font-size: 0.95rem; font-weight: 500; cursor: pointer; }
        .dropdown-item:hover { background: #F9FAFB; }

        .sidebar-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 90; }
        
        /* Modal Styles (Compressed) */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); justify-content: center; align-items: center; z-index: 2000; }
        .modal.active { display: flex; }
        .modal-content { background: white; padding: 2rem; border-radius: 16px; width: 400px; }
        .form-group input { width: 100%; padding: 0.8rem; border: 1px solid #E5E7EB; border-radius: 8px; outline: none; margin-top:5px; }
        .friend-select-list { max-height: 200px; overflow-y: auto; border: 1px solid #E5E7EB; border-radius: 8px; padding: 10px; margin-top:5px;}
        .friend-option { display: flex; align-items: center; gap: 10px; padding: 8px; }
        .modal-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 1.5rem; }
        .btn-cancel { background: white; border: 1px solid #E5E7EB; padding: 8px 16px; border-radius: 8px; font-weight: 600; }
        .btn-create-group { background: black; color: white; border: none; padding: 8px 16px; border-radius: 8px; font-weight: 600; }
        .logo{ height: 60px; width: 60px; margin-top: 13px; }

        /* --- MOBILE RESPONSIVENESS --- */
        @media (max-width: 768px) {
            .sidebar { position: fixed; left: -260px; height: 100%; }
            .sidebar.active { left: 0; }
            .sidebar-overlay.active { display: block; }
            .mobile-menu-btn { display: block; }

            .chat-layout { position: relative; width: 100%; }
            
            /* List View (Default Mobile) */
            .message-list-panel { width: 100%; display: flex; }
            
            /* Chat Window (Hidden initially on mobile) */
            .chat-window { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 200; }
            .chat-window.active { display: flex; }
            
            .input-area { padding: 1rem; }
            .chat-header { padding: 0.5rem 1rem; }
        }
    </style>
</head>
<body>

    <div class="sidebar-overlay" onclick="toggleSidebar()"></div>

    <aside class="sidebar" id="sidebar">
        <div class="brand"><div><img src="projectify.png" class="logo"></div><div>Projectify</div></div>
        <div class="menu-title">Main Menu</div>
        <a href="dashboard.html" class="nav-item"><i class="ri-dashboard-line"></i> Dashboard</a>
        <a href="projects.html" class="nav-item"><i class="ri-folder-3-line"></i> Projects</a>
        <a href="notification.html" class="nav-item"><i class="ri-notification-3-line"></i> Notifications</a>
        <a href="#" class="nav-item active"><i class="ri-chat-1-fill"></i> Chat</a>
        <a href="profile.html" class="nav-item"><i class="ri-user-line"></i> Profile</a>
        <a href="about.html" class="nav-item"><i class="ri-information-line"></i> About Us</a>
        <div class="user-profile">
            <img src="" class="avatar-small" id="sidebarAvatar">
            <div class="user-info"><h4 id="sidebarName">...</h4><span style="font-size:0.8rem;">Admin</span></div>
            <i class="ri-logout-box-r-line" onclick="logout()" style="margin-left: auto; cursor: pointer; color: red;"></i>
        </div>
    </aside>

    <div class="chat-layout">
        <div class="message-list-panel">
            <div class="msg-header">
                <div class="msg-title-row">
                    <div style="display:flex; align-items:center;">
                        <i class="ri-menu-line mobile-menu-btn" onclick="toggleSidebar()"></i>
                        <h2>Messages</h2>
                    </div>
                    <div class="add-btn" onclick="toggleDropdown()"><i class="ri-add-line"></i></div>
                </div>
                <div class="dropdown-menu" id="chatDropdown">
                    <div class="dropdown-item" onclick="openGroupModal()"><i class="ri-group-line"></i> New Group</div>
                    <div class="dropdown-item" onclick="openNewChatModal()"><i class="ri-user-add-line"></i> New Private Chat</div>
                </div>
                <div class="search-box">
                    <i class="ri-search-line"></i>
                    <input type="text" id="searchContacts" placeholder="Search chats...">
                </div>
            </div>
            <div class="contacts-container" id="contactsList"><p style="color:gray; text-align:center; margin-top:20px;">Loading chats...</p></div>
        </div>

        <div class="chat-window" id="mainChatWindow">
            <div class="empty-chat" id="emptyState">
                <i class="ri-chat-smile-2-line" style="font-size: 3rem; margin-bottom: 10px;"></i><p>Select a chat to start messaging</p>
            </div>
            <div id="chatContent" style="display: none; flex-direction: column; height: 100%;">
                <div class="chat-header">
                    <div style="display:flex; align-items:center;">
                        <i class="ri-arrow-left-line" onclick="closeMobileChat()" style="font-size:1.5rem; margin-right:10px; display:none;" id="mobileBackBtn"></i>
                        <div class="chat-user-info" id="headerUserInfo">
                            <img src="" class="c-avatar" id="activeAvatar">
                            <div><h3 id="activeName">...</h3><span>Online</span></div>
                        </div>
                    </div>
                    <div class="header-icons"><i class="ri-information-line" id="infoIconBtn"></i></div>
                </div>
                <div class="messages-area" id="messagesContainer"></div>
                <div class="input-area">
                    <div class="input-wrapper"><input type="text" class="chat-input" id="messageInput" placeholder="Type a message..."></div>
                    <button class="send-btn" onclick="sendMessage()"><i class="ri-send-plane-fill"></i></button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="newChatModal">
        <div class="modal-content">
            <div class="modal-header"><h2>Start New Chat</h2><span onclick="closeNewChatModal()" style="cursor:pointer;">&times;</span></div>
            <div id="modalFriendList" style="max-height:150px; overflow-y:auto;"></div>
            <div style="margin:15px 0; border-top:1px solid #eee; text-align:center;"><span style="background:white; position:relative; top:-10px; padding:0 10px; color:#999;">OR</span></div>
            <div class="form-group"><label>Invite Email</label><input type="email" id="newFriendEmail"></div>
            <div class="modal-actions"><button class="btn-cancel" onclick="closeNewChatModal()">Cancel</button><button class="btn-create-group" onclick="sendFriendRequest()">Send Request</button></div>
        </div>
    </div>

    <div class="modal" id="groupModal">
        <div class="modal-content">
            <div class="modal-header"><h2>Create New Group</h2><span onclick="closeGroupModal()" style="cursor:pointer;">&times;</span></div>
            <div class="form-group"><label>Group Name</label><input type="text" id="groupName"></div>
            <div class="form-group"><label>Members</label><div class="friend-select-list" id="friendSelectionList"></div></div>
            <div class="modal-actions"><button class="btn-cancel" onclick="closeGroupModal()">Cancel</button><button class="btn-create-group" onclick="createGroup()">Create</button></div>
        </div>
    </div>

    <div class="modal" id="viewProfileModal">
        <div class="modal-content">
            <div style="text-align:right;"><span onclick="closeViewProfileModal()" style="cursor:pointer; font-size:1.5rem;">&times;</span></div>
            <h2 id="vpName" style="text-align:center;"></h2><p id="vpEmail" style="text-align:center; color:gray;"></p>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, query, orderBy, onSnapshot, addDoc, serverTimestamp, where, getDocs, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDL6UGG7s7o-MC24qpHS77LgY54jxD0sRI",
            authDomain: "taskmanagement-60f9b.firebaseapp.com",
            projectId: "taskmanagement-60f9b",
            storageBucket: "taskmanagement-60f9b.firebasestorage.app",
            messagingSenderId: "761115679422",
            appId: "1:761115679422:web:ee166eb1935bd360aa9cef",
            measurementId: "G-F55KPBTQ3G"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        enableIndexedDbPersistence(db).catch((err) => {});

        let currentUser = null;
        let activeChatId = null;
        let friendsListCache = []; 

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                const userSnap = await getDoc(doc(db, "users", user.uid));
                let userPhoto = user.photoURL;
                if (userSnap.exists() && userSnap.data().profileImage) userPhoto = userSnap.data().profileImage;
                else if (!userPhoto) userPhoto = `https://ui-avatars.com/api/?name=${user.displayName}`;
                
                document.getElementById('sidebarName').innerText = user.displayName || "User";
                document.getElementById('sidebarAvatar').src = userPhoto;
                loadContactsAndGroups();
            } else { window.location.href = "login.html"; }
        });

        // ... (Standard Load Logic same as before, condensed) ...
        async function loadContactsAndGroups() {
            const container = document.getElementById('contactsList'); container.innerHTML = "";
            const groupQ = query(collection(db, "chats"), where("type", "==", "group"), where("members", "array-contains", currentUser.email));
            onSnapshot(groupQ, (snapshot) => {
                document.querySelectorAll('.group-item').forEach(e => e.remove());
                snapshot.forEach(doc => {
                    const group = doc.data();
                    const div = document.createElement('div'); div.className = "contact-item group-item";
                    div.innerHTML = `<div class="c-avatar" style="background:#000; color:white; display:grid; place-items:center;">${group.name.charAt(0)}</div><div class="c-info"><div class="c-name">${group.name}</div><div class="last-msg">Group Chat</div></div>`;
                    div.onclick = () => openChat(doc.id, group.name, `https://ui-avatars.com/api/?name=${group.name}`, div, null);
                    container.prepend(div);
                });
            });
            const userDoc = await getDoc(doc(db, "users", currentUser.uid));
            if (userDoc.exists() && userDoc.data().friends) {
                const friendEmails = userDoc.data().friends;
                const friendPromises = friendEmails.map(async (email) => {
                    const q = query(collection(db, "users"), where("email", "==", email));
                    const snapshot = await getDocs(q);
                    let name = email.split('@')[0], avatar = `https://ui-avatars.com/api/?name=${name}`;
                    if (!snapshot.empty) { const d = snapshot.docs[0].data(); if (d.fullName) name = d.fullName; if (d.profileImage) avatar = d.profileImage; }
                    return { email, name, avatar };
                });
                friendsListCache = await Promise.all(friendPromises);
                friendsListCache.forEach(f => {
                    const chatId = [currentUser.email, f.email].sort().join("_");
                    const div = document.createElement('div'); div.className = "contact-item friend-item"; div.setAttribute('data-name', f.name.toLowerCase());
                    div.innerHTML = `<img src="${f.avatar}" class="c-avatar"><div class="c-info"><div class="c-name">${f.name}</div><div class="last-msg">Private Chat</div></div>`;
                    div.onclick = () => openChat(chatId, f.name, f.avatar, div, f.email);
                    container.appendChild(div);
                });
            }
        }

        // --- MODIFIED OPEN CHAT FOR MOBILE ---
        window.openChat = (chatId, name, avatar, element, email) => {
            document.querySelectorAll('.contact-item').forEach(el => el.classList.remove('active'));
            element.classList.add('active');
            document.getElementById('emptyState').style.display = "none";
            document.getElementById('chatContent').style.display = "flex";
            document.getElementById('activeName').innerText = name;
            document.getElementById('activeAvatar').src = avatar;
            activeChatId = chatId;
            
            // MOBILE: Show Chat Window, Hide List
            if (window.innerWidth < 768) {
                document.querySelector('.message-list-panel').style.display = 'none';
                document.querySelector('.chat-window').classList.add('active');
                document.querySelector('.chat-window').style.display = 'flex';
                document.getElementById('mobileBackBtn').style.display = 'block';
            }

            loadMessages(chatId);
        };

        window.closeMobileChat = () => {
            document.querySelector('.chat-window').classList.remove('active');
            document.querySelector('.chat-window').style.display = 'none';
            document.querySelector('.message-list-panel').style.display = 'flex';
        }

        // ... (Rest of logic: loadMessages, sendMessage, modals remains same) ...
        
        function loadMessages(chatId) {
            const container = document.getElementById('messagesContainer'); container.innerHTML = "";
            onSnapshot(query(collection(db, "chats", chatId, "messages"), orderBy("timestamp", "asc")), (snapshot) => {
                container.innerHTML = "";
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const isMe = data.sender === currentUser.email;
                    const time = data.timestamp ? new Date(data.timestamp.toDate()).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : "..";
                    container.innerHTML += `<div class="message ${isMe ? 'outgoing' : 'incoming'}"><div class="bubble">${data.text}<span class="msg-time">${time}</span></div></div>`;
                });
                container.scrollTop = container.scrollHeight;
            });
        }

        window.sendMessage = async () => {
            const input = document.getElementById('messageInput');
            const text = input.value.trim();
            if(!text || !activeChatId) return;
            input.value = "";
            try { await addDoc(collection(db, "chats", activeChatId, "messages"), { text: text, sender: currentUser.email, timestamp: serverTimestamp() }); } catch(e) {}
        }
        document.getElementById('messageInput').addEventListener('keypress', (e) => { if(e.key === 'Enter') sendMessage(); });

        window.logout = () => signOut(auth).then(() => window.location.href = "login.html");
        window.toggleSidebar = () => { document.getElementById('sidebar').classList.toggle('active'); document.querySelector('.sidebar-overlay').classList.toggle('active'); }
        window.toggleDropdown = () => document.getElementById('chatDropdown').classList.toggle('show');
        
        // Simple Modal Logic for brevity
        window.openNewChatModal = () => { document.getElementById('newChatModal').classList.add('active'); document.getElementById('chatDropdown').classList.remove('show'); }
        window.closeNewChatModal = () => document.getElementById('newChatModal').classList.remove('active');
        window.openGroupModal = () => { document.getElementById('groupModal').classList.add('active'); document.getElementById('chatDropdown').classList.remove('show'); }
        window.closeGroupModal = () => document.getElementById('groupModal').classList.remove('active');
        window.viewFriendProfile = () => document.getElementById('viewProfileModal').classList.add('active');
        window.closeViewProfileModal = () => document.getElementById('viewProfileModal').classList.remove('active');
    </script>
</body>
</html>