<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Projects - AProjectO</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">

    <style>
        :root { --bg-color: #F9FAFB; --sidebar-width: 260px; --primary-black: #000000; --text-main: #111827; --text-gray: #6B7280; --border-color: #E5E7EB; --white: #ffffff; --blue-btn: #6366F1; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { display: flex; height: 100vh; background-color: var(--bg-color); color: var(--text-main); overflow: hidden; }
        
        /* Animations */
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes scaleIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* Sidebar */
        .sidebar { width: var(--sidebar-width); background: var(--white); border-right: 1px solid var(--border-color); padding: 1.5rem; display: flex; flex-direction: column; flex-shrink: 0; transition: transform 0.3s ease; z-index: 100; }
        .brand { display: flex; align-items: center; gap: 10px; margin-bottom: 2.5rem; font-weight: 800; font-size: 1.2rem; }
        .menu-title { font-size: 0.75rem; color: #9CA3AF; margin-bottom: 1rem; font-weight: 600; text-transform: uppercase; }
        .nav-item { display: flex; align-items: center; gap: 12px; padding: 0.75rem 1rem; border-radius: 8px; color: var(--text-gray); text-decoration: none; font-weight: 500; margin-bottom: 0.5rem; transition: 0.2s; }
        .nav-item:hover:not(.active) { background: #F3F4F6; }
        .nav-item.active { background-color: var(--primary-black); color: white; }
        .user-profile { margin-top: auto; display: flex; align-items: center; gap: 12px; padding-top: 1.5rem; border-top: 1px solid var(--border-color); }
        .avatar-small { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; }

        /* Main Content */
        .main-content { flex: 1; padding: 2rem; overflow-y: auto; position: relative; }
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        
        .mobile-menu-area { display: flex; align-items: center; gap: 15px; }
        .mobile-menu-btn { display: none; font-size: 1.5rem; cursor: pointer; }

        .search-bar { background: #F3F4F6; padding: 8px 16px; border-radius: 20px; display: flex; align-items: center; gap: 8px; width: 250px; color: var(--text-gray); border: 1px solid transparent; transition: 0.2s; }
        .search-bar:focus-within { border-color: var(--text-gray); background: white; }
        .search-bar input { border: none; background: transparent; outline: none; width: 100%; font-size: 0.9rem; }

        .page-header { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 2.5rem; animation: fadeInUp 0.5s ease-out forwards; }
        .page-title h1 { font-size: 2rem; font-weight: 800; letter-spacing: -0.5px; }
        .actions-area { display: flex; align-items: center; gap: 15px; }
        
        .filter-group { background: white; border: 1px solid var(--border-color); padding: 4px; border-radius: 8px; display: flex; gap: 4px; }
        .filter-btn { padding: 8px 16px; border-radius: 6px; border: none; background: transparent; color: var(--text-gray); font-weight: 600; font-size: 0.9rem; cursor: pointer; transition: 0.2s; }
        .filter-btn.active { background: var(--primary-black); color: white; }
        .btn-new { background: var(--primary-black); color: white; padding: 10px 20px; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px; }

        /* Projects Grid */
        .projects-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 2rem; animation: fadeInUp 0.7s ease-out forwards; }
        
        /* Project Card Styles */
        .project-card { background: white; border-radius: 16px; border: 1px solid transparent; box-shadow: 0 2px 5px rgba(0,0,0,0.02); transition: all 0.3s ease; display: flex; flex-direction: column; justify-content: space-between; min-height: 220px; position: relative; overflow: hidden; cursor: pointer; }
        .project-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.05); }
        .card-img-cover { height: 120px; width: 100%; object-fit: cover; display: block; }
        .card-content-area { padding: 1.5rem; }
        .card-border-indicator { position: absolute; left: 0; top: 20px; bottom: 20px; width: 4px; border-radius: 0 4px 4px 0; background: #000; }
        .card-top { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem; }
        .card-cat { font-size: 0.7rem; font-weight: 700; color: #9CA3AF; text-transform: uppercase; letter-spacing: 0.5px; }
        .card-avatars { display: flex; }
        .card-avatars img { width: 28px; height: 28px; border-radius: 50%; border: 2px solid white; margin-left: -10px; }
        .card-title { font-size: 1.3rem; font-weight: 700; color: var(--text-main); margin-bottom: 1.5rem; line-height: 1.3; }
        .progress-section { margin-bottom: 1.5rem; }
        .progress-info { display: flex; justify-content: space-between; font-size: 0.85rem; font-weight: 600; margin-bottom: 8px; }
        .progress-track { width: 100%; height: 8px; background: #F3F4F6; border-radius: 4px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--primary-black); border-radius: 4px; transition: width 1s ease; }
        .card-footer { display: flex; justify-content: space-between; align-items: center; padding-top: 1rem; border-top: 1px solid #F9FAFB; }
        .date-tag { display: flex; align-items: center; gap: 6px; font-size: 0.85rem; color: var(--text-gray); background: #F9FAFB; padding: 6px 10px; border-radius: 6px; }
        .menu-dots { font-size: 1.2rem; color: #D1D5DB; cursor: pointer; transition:0.2s; }
        .menu-dots:hover { color: #EF4444; transform: scale(1.1); }

        /* Modal & Overlay */
        .sidebar-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 90; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); justify-content: center; align-items: center; z-index: 1000; }
        .modal.active { display: flex; animation: fadeIn 0.2s ease-out forwards; }
        .modal-content { background: white; padding: 2rem; border-radius: 16px; width: 500px; max-height: 90vh; overflow-y: auto; animation: scaleIn 0.3s ease-out forwards; }
        
        .nested-modal { z-index: 2000; } 
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; border-bottom: 1px solid #E5E7EB; padding-bottom: 1rem; }
        .form-group { margin-bottom: 1.2rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 600; font-size: 0.9rem; }
        .form-group input, .form-group select { width: 100%; padding: 0.8rem; border: 1px solid #E5E7EB; border-radius: 8px; font-size: 1rem; outline: none; }
        
        /* Image Upload Styles */
        .image-upload-box { border: 2px dashed #E5E7EB; border-radius: 8px; padding: 15px; text-align: center; cursor: pointer; position: relative; transition: 0.2s; }
        .image-preview { width: 100%; height: 150px; object-fit: cover; border-radius: 8px; margin-top: 10px; display: none; }
        .btn-add-trigger { width: 100%; border: 1px solid var(--blue-btn); background-color: white; color: var(--blue-btn); padding: 10px; border-radius: 30px; font-weight: 600; cursor: pointer; display: flex; justify-content: center; align-items: center; gap: 8px; transition: 0.2s; }
        .staged-members { margin-top: 10px; display: flex; flex-wrap: wrap; gap: 8px; }
        .staged-chip { font-size: 0.8rem; background: #F3F4F6; padding: 4px 10px; border-radius: 12px; display: flex; gap: 5px; align-items: center; }
        
        .modal-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 2rem; }
        .btn-cancel { background: white; border: 1px solid #E5E7EB; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; }
        .btn-save { background: black; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; }
        .logo{ height: 60px; width: 60px; margin-top: 13px; }

        /* --- MOBILE RESPONSIVENESS --- */
        @media (max-width: 768px) {
            .sidebar { position: fixed; left: -260px; height: 100%; }
            .sidebar.active { left: 0; }
            .sidebar-overlay.active { display: block; }
            .mobile-menu-btn { display: block; }
            
            .projects-grid { grid-template-columns: 1fr; }
            .page-header { flex-direction: column; align-items: flex-start; gap: 15px; }
            .actions-area { width: 100%; justify-content: space-between; }
            .search-bar { display: none; } /* Simplify header for mobile */
            .top-bar { justify-content: space-between; }
            
            .main-content { padding: 1.5rem; }
            .modal-content { width: 90%; }
        }
    </style>
</head>
<body>

    <div class="sidebar-overlay" onclick="toggleSidebar()"></div>

    <aside class="sidebar" id="sidebar">
        <div class="brand"><div><img src="projectify.png" class="logo"></div><div>Projectify</div></div>
        <div class="menu-title">Main Menu</div>
        <a href="dashboard.html" class="nav-item"><i class="ri-dashboard-line"></i> Dashboard</a>
        <a href="#" class="nav-item active"><i class="ri-folder-3-fill"></i> Projects</a>
        <a href="notification.html" class="nav-item"><i class="ri-notification-3-line"></i> Notifications</a>
        <a href="chat.html" class="nav-item"><i class="ri-chat-1-line"></i> Chat</a>
        <a href="profile.html" class="nav-item"><i class="ri-user-line"></i> Profile</a>
        <a href="about.html" class="nav-item"><i class="ri-information-line"></i> About Us</a>
        <div class="user-profile">
            <img src="" class="avatar-small" id="sidebarAvatar">
            <div class="user-info"><h4 id="sidebarName">...</h4><span style="font-size:0.8rem;">Admin</span></div>
            <i class="ri-logout-box-r-line" onclick="logout()" style="margin-left: auto; cursor: pointer; color: red;"></i>
        </div>
    </aside>

    <main class="main-content">
        <div class="top-bar">
            <div class="mobile-menu-area">
                <i class="ri-menu-line mobile-menu-btn" onclick="toggleSidebar()"></i>
                <div class="search-bar">
                    <i class="ri-search-line"></i>
                    <input type="text" id="searchInput" placeholder="Search projects...">
                </div>
            </div>
            <a href="notification.html" style="color:inherit;"><i class="ri-notification-3-line" style="font-size: 1.2rem; cursor: pointer;"></i></a>
        </div>

        <div class="page-header">
            <div class="page-title"><span>Workspace</span><h1>All Projects</h1></div>
            <div class="actions-area">
                <div class="filter-group">
                    <button class="filter-btn active" onclick="filterProjects('all')">All</button>
                    <button class="filter-btn" onclick="filterProjects('active')">Active</button>
                    <button class="filter-btn" onclick="filterProjects('completed')">Completed</button>
                </div>
                <button class="btn-new" onclick="openModal()">+ New</button>
            </div>
        </div>

        <div class="projects-grid" id="projectsGrid">
            <p style="color:gray;">Loading projects...</p>
        </div>
    </main>

    <div class="modal" id="projectModal">
        <div class="modal-content">
            <div class="modal-header"><h2>Create New Project</h2><span onclick="closeModal()" style="cursor:pointer; font-size:1.5rem;">&times;</span></div>
            
            <div class="form-group">
                <label>Project Picture</label>
                <div class="image-upload-box" onclick="document.getElementById('projImgInput').click()">
                    <div id="uploadPlaceholder">
                        <i class="ri-image-add-line" style="font-size: 1.5rem; color: #6B7280;"></i>
                        <p style="color:#6B7280; font-size:0.9rem;">Click to upload cover image</p>
                    </div>
                    <img id="projImgPreview" class="image-preview">
                    <p id="uploadStatus" style="font-size:0.8rem; color:blue; display:none; margin-top:5px;">Uploading...</p>
                </div>
                <input type="file" id="projImgInput" hidden accept="image/*">
            </div>

            <div class="form-group"><label>Project Name</label><input type="text" id="projName" placeholder="e.g. Website Redesign"></div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div class="form-group"><label>Category</label><input type="text" id="projCategory" placeholder="e.g. Design"></div>
                <div class="form-group"><label>Layout View</label><select id="projLayout"><option value="Board">Board View</option><option value="List">List View</option></select></div>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div class="form-group"><label>Theme Color</label><select id="projColor"><option value="#000000">Black</option><option value="#4F46E5">Indigo</option><option value="#10B981">Green</option><option value="#EF4444">Red</option></select></div>
                <div class="form-group"><label>Visibility</label><select id="projVisibility"><option value="Private">Private</option><option value="Public">Public</option></select></div>
            </div>
            
            <div class="form-group" style="margin-top:10px;">
                <button class="btn-add-trigger" onclick="openInviteMemberModal()"><i class="ri-add-box-line"></i> Add Member</button>
                <div class="staged-members" id="stagedMembersList"></div>
            </div>

            <div class="modal-actions"><button class="btn-cancel" onclick="closeModal()">Cancel</button><button class="btn-save" onclick="createNewProject()">Create Project</button></div>
        </div>
    </div>

    <div class="modal nested-modal" id="inviteMemberModal">
        <div class="modal-content" style="width: 350px; padding:1.5rem;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">
                <h3 style="font-size:1.2rem; color:#333;">Contacts Info</h3>
                <span onclick="closeInviteMemberModal()" style="cursor:pointer; font-size:1.5rem; color:#999;">&times;</span>
            </div>
            <div class="contacts-input-container" style="background:white; padding:10px; border:1px solid #ddd; border-radius:8px; display:flex; margin-bottom:15px;">
                <input type="email" class="contacts-input" id="tempInviteEmail" placeholder="name@gmail.com" style="border:none; outline:none; width:100%;">
                <i class="ri-mail-send-line" style="color:#6366F1;"></i>
            </div>
            <button class="btn-send-invite" onclick="confirmAddMember()" style="width:100%; padding:10px; background:#6366F1; color:white; border:none; border-radius:8px; font-weight:600;">Send Invitation</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
        import { 
            getFirestore, collection, addDoc, query, where, onSnapshot, deleteDoc, doc, 
            enableIndexedDbPersistence, limit, orderBy, getDoc
        } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDL6UGG7s7o-MC24qpHS77LgY54jxD0sRI",
            authDomain: "taskmanagement-60f9b.firebaseapp.com",
            projectId: "taskmanagement-60f9b",
            storageBucket: "taskmanagement-60f9b.firebasestorage.app",
            messagingSenderId: "761115679422",
            appId: "1:761115679422:web:ee166eb1935bd360aa9cef",
            measurementId: "G-F55KPBTQ3G"
        };

        const CLOUDINARY_URL = "https://api.cloudinary.com/v1_1/dl6gzgu6i/image/upload";
        const CLOUDINARY_UPLOAD_PRESET = "NEWSIMAGE";

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        enableIndexedDbPersistence(db).catch((err) => {});

        let currentUser = null;
        let allProjectsData = [];
        let projectMembers = []; 
        let uploadedImageUrl = ""; 
        let currentFilter = 'all'; 

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                const userSnap = await getDoc(doc(db, "users", user.uid));
                let userPhoto = user.photoURL;
                if (userSnap.exists() && userSnap.data().profileImage) userPhoto = userSnap.data().profileImage;
                else if (!userPhoto) userPhoto = `https://ui-avatars.com/api/?name=${user.displayName}`;

                document.getElementById('sidebarName').innerText = user.displayName || "User";
                document.getElementById('sidebarAvatar').src = userPhoto;
                loadProjects(user.email);
            } else { window.location.href = "login.html"; }
        });

        function loadProjects(email) {
            const q = query(collection(db, "projects"), where("access_list", "array-contains", email), orderBy("createdAt", "desc"), limit(20));
            onSnapshot(q, (snapshot) => {
                allProjectsData = [];
                snapshot.forEach((doc) => { allProjectsData.push({ id: doc.id, ...doc.data() }); });
                renderProjects();
            });
        }

        window.filterProjects = (type) => {
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            currentFilter = type;
            renderProjects();
        }
        document.getElementById('searchInput').addEventListener('input', () => renderProjects());

        function renderProjects() {
            const container = document.getElementById('projectsGrid');
            container.innerHTML = "";
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            let filtered = allProjectsData;
            if (currentFilter === 'active') filtered = filtered.filter(p => (p.progress || 0) < 100);
            else if (currentFilter === 'completed') filtered = filtered.filter(p => (p.progress || 0) >= 100);
            if (searchTerm) filtered = filtered.filter(p => p.name.toLowerCase().includes(searchTerm) || (p.category && p.category.toLowerCase().includes(searchTerm)));

            if(filtered.length === 0) { container.innerHTML = "<p style='color:gray; grid-column: 1/-1; text-align:center;'>No matching projects found.</p>"; return; }

            filtered.forEach((data, index) => {
                let avatarHTML = "";
                if(data.access_list) {
                    data.access_list.slice(0, 3).forEach(email => { avatarHTML += `<img src="https://ui-avatars.com/api/?name=${email.charAt(0)}" title="${email}">`; });
                    if(data.access_list.length > 3) avatarHTML += `<span style="font-size:0.8rem; margin-left:5px; color:gray;">+${data.access_list.length - 3}</span>`;
                }
                let deleteBtnHtml = data.access_list && data.access_list[0] === currentUser.email ? `<i class="ri-delete-bin-line menu-dots" onclick="event.stopPropagation(); deleteProject('${data.id}')" style="color:#EF4444;"></i>` : `<span style="font-size:0.8rem; color:gray;">Shared</span>`;
                let imageHtml = data.image ? `<img src="${data.image}" class="card-img-cover">` : '';
                let paddingStyle = data.image ? '' : 'padding: 1.8rem;'; 
                let contentPadding = data.image ? 'padding: 1.5rem;' : 'padding:0;';
                const createdDate = data.createdAt ? new Date(data.createdAt.toDate()).toLocaleDateString() : 'N/A';

                container.innerHTML += `
                    <div class="project-card" style="animation-delay: ${index * 0.05}s; cursor: pointer; ${paddingStyle}" onclick="window.location.href='project_details.html?id=${data.id}'">
                        ${imageHtml}
                        <div class="card-content-area" style="${contentPadding}">
                            ${data.image ? '' : `<div class="card-border-indicator" style="background-color: ${data.themeColor || '#000'}"></div>`}
                            <div class="card-top"><div class="card-cat">${data.category || 'GENERAL'}</div><div class="card-avatars">${avatarHTML}</div></div>
                            <div class="card-title">${data.name}</div>
                            <div class="progress-section"><div class="progress-info"><span>Progress</span><span>${data.progress || 0}%</span></div><div class="progress-track"><div class="progress-fill" style="width: ${data.progress || 0}%; background-color:${data.themeColor || '#000'}"></div></div></div>
                            <div class="card-footer"><div class="date-tag"><i class="ri-calendar-line"></i> ${createdDate}</div>${deleteBtnHtml}</div>
                        </div>
                    </div>`;
            });
        }

        // --- IMAGE UPLOAD ---
        document.getElementById('projImgInput').addEventListener('change', async (e) => {
            const file = e.target.files[0]; if(!file) return;
            document.getElementById('uploadStatus').style.display = 'block';
            const formData = new FormData(); formData.append('file', file); formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
            try {
                const res = await fetch(CLOUDINARY_URL, { method: 'POST', body: formData });
                const data = await res.json();
                uploadedImageUrl = data.secure_url;
                document.getElementById('uploadPlaceholder').style.display = 'none';
                const preview = document.getElementById('projImgPreview');
                preview.src = uploadedImageUrl; preview.style.display = 'block';
                document.getElementById('uploadStatus').innerText = "Image Uploaded!"; document.getElementById('uploadStatus').style.color = "green";
            } catch (err) { console.error(err); }
        });

        // --- MODAL & HELPERS ---
        window.openModal = () => { document.getElementById('projectModal').classList.add('active'); projectMembers = []; uploadedImageUrl = ""; renderStagedMembers(); };
        window.closeModal = () => document.getElementById('projectModal').classList.remove('active');
        window.openInviteMemberModal = () => { document.getElementById('inviteMemberModal').classList.add('active'); document.getElementById('tempInviteEmail').value = ""; };
        window.closeInviteMemberModal = () => document.getElementById('inviteMemberModal').classList.remove('active');
        
        window.confirmAddMember = () => {
            const email = document.getElementById('tempInviteEmail').value.trim();
            if (email && email.includes('@') && !projectMembers.includes(email)) { projectMembers.push(email); renderStagedMembers(); closeInviteMemberModal(); } else alert("Invalid email.");
        };
        function renderStagedMembers() {
            const container = document.getElementById('stagedMembersList'); container.innerHTML = "";
            projectMembers.forEach(email => { container.innerHTML += `<div class="staged-chip">${email} <i class="ri-close-line" style="cursor:pointer; font-weight:bold;" onclick="removeStagedMember('${email}')"></i></div>`; });
        }
        window.removeStagedMember = (email) => { projectMembers = projectMembers.filter(e => e !== email); renderStagedMembers(); }

        window.createNewProject = async () => {
            const name = document.getElementById('projName').value;
            if(!name) return alert("Name required");
            try {
                const docRef = await addDoc(collection(db, "projects"), {
                    name: name, category: document.getElementById('projCategory').value || "Development",
                    layout: document.getElementById('projLayout').value, themeColor: document.getElementById('projColor').value,
                    visibility: document.getElementById('projVisibility').value, image: uploadedImageUrl, progress: 0,
                    access_list: [currentUser.email], createdAt: new Date()
                });
                if (projectMembers.length > 0) {
                    projectMembers.forEach(async (email) => {
                        await addDoc(collection(db, "notifications"), { toEmail: email, fromEmail: currentUser.email, title: "Project Invitation", message: `Join project: ${name}`, type: "invite", projectId: docRef.id, timestamp: new Date(), read: false });
                    });
                }
                closeModal(); alert(`Project Created!`);
            } catch (e) { alert("Error: " + e.message); }
        }

        window.deleteProject = async (id) => { if(confirm("Delete?")) await deleteDoc(doc(db, "projects", id)); }
        window.logout = () => signOut(auth).then(() => window.location.href = "login.html");
        window.toggleSidebar = () => { document.getElementById('sidebar').classList.toggle('active'); document.querySelector('.sidebar-overlay').classList.toggle('active'); }
    </script>
</body>
</html>